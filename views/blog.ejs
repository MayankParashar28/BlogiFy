<!DOCTYPE html>
<html lang="en" data-theme="">
  <head>
    <%- include('./partials/header') %>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
      /* Theme Variables */
      :root {
        --bg-color-light: #ffffff;
        --text-color-light: #000;
        --card-bg-light: #f8f9fa;
        --border-color-light: #ddd;
        --shadow-color-light: rgba(0, 0, 0, 0.1);
        --accent-color-light: #007bff;
        --accent-hover-light: #0056b3;
        --font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;

        --bg-color-dark: #1a1a1a;
        --text-color-dark: #ffffff;
        --card-bg-dark: #2d2d2d;
        --border-color-dark: #404040;
        --shadow-color-dark: rgba(0, 0, 0, 0.3);
        --accent-color-dark: #00b4ff;
        --accent-hover-dark: #0095d9;
      }

      * {
        font-family: var(--font-family);
      }

      /* Apply theme variables */
      [data-theme="light"] {
        --bg-color: var(--bg-color-light);
        --text-color: var(--text-color-light);
        --card-bg: var(--card-bg-light);
        --border-color: var(--border-color-light);
        --shadow-color: var(--shadow-color-light);
        --accent-color: var(--accent-color-light);
        --accent-hover: var(--accent-hover-light);
      }

      [data-theme="dark"] {
        --bg-color: var(--bg-color-dark);
        --text-color: var(--text-color-dark);
        --card-bg: var(--card-bg-dark);
        --border-color: var(--border-color-dark);
        --shadow-color: var(--shadow-color-dark);
        --accent-color: var(--accent-color-dark);
        --accent-hover: var(--accent-hover-dark);
      }

      /* Theme Toggle Button */
      .theme-toggle {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--card-bg);
        border: 2px solid var(--border-color);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 2px 10px var(--shadow-color);
        z-index: 1000;
        transition: all 0.3s ease;
      }

      .theme-toggle:hover {
        transform: scale(1.1);
      }

      .theme-toggle i {
        font-size: 1.5rem;
        color: var(--text-color);
      }

      /* Base styles with theme variables */
      body {
        background-color: var(--bg-color);
        color: var(--text-color);
        font-family: var(--font-family);
        font-weight: 500;
        transition: background-color 0.3s ease, color 0.3s ease;
      }

      .blog-container {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        box-shadow: 0 2px 10px var(--shadow-color);
        transition: background-color 0.3s ease, border-color 0.3s ease;
      }

      .blog-title {
        color: var(--text-color);
        font-weight: 800;
        text-shadow: 2px 2px 4px var(--shadow-color);
        transition: color 0.3s ease;
      }

      .theme-text {
        color: var(--text-color);
        font-weight: 600;
        transition: color 0.3s ease;
      }

      .form-control {
        background-color: var(--card-bg);
        color: var(--text-color);
        border: 1px solid var(--border-color);
        transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
      }

      .form-control::placeholder {
        color: var(--text-color);
        opacity: 0.6;
      }

      .blog-image {
        max-height: 400px;
        width: 80%;
        object-fit: cover;
        transition: transform 0.5s ease;
        filter: brightness(0.9);
      }

      .blog-image:hover {
        transform: scale(1.05);
        filter: brightness(1);
      }

      .share-buttons a {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        font-size: 16px;
        color: white;
        text-decoration: none;
        transition: 0.5s;
        margin: 5px 5px;
        background-color: rgba(0, 0, 0, 0.1);
      }

      .share-buttons a:hover {
        transform: scale(1.3) rotate(360deg);
      }

      .like-button {
        display: flex;
        align-items: center;
        cursor: pointer;
        font-size: 18px;
        color: #dc3545;
        border: none;
        background: none;
        transition: 0.3s ease-in-out;
      }

      .like-button i {
        font-size: 24px;
        margin-right: 5px;
        transition: 0.3s;
      }

      .like-button:hover i {
        transform: scale(1.2) rotate(-20deg);
      }

      .follow-btn {
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: bold;
        cursor: pointer;
        transition: 0.3s;
        border: 2px solid #007bff;
        background-color: #007bff;
        color: white;
      }

      .follow-btn.unfollow {
        background-color: white;
        color: #007bff;
      }

      pre {
        white-space: pre-wrap;
        /* Allows wrapping */
        word-wrap: break-word;
        /* Ensures long words break */
        overflow-x: auto;
        /* Allows horizontal scrolling only when needed */
        max-width: 100%;
        /* Prevents it from exceeding the container */
      }

      #progress-container {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 5px;
        background: rgba(0, 0, 0, 0.1);
        z-index: 1000;
      }

      #progress-bar {
        height: 5px;
        width: 0%;
        background: #ff6600;
        /* Customize the color */
        transition: width 0.2s ease-out;
      }

      .bookmark-btn {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
      }

      .bookmark-btn i {
        color: #888;
        transition: color 0.3s;
      }

      .bookmark-btn i.fa-solid {
        color: #ff6600;
        /* Change color when bookmarked */
      }

      /* Default (Light Mode) */
      .blog-title {
        color: #333;
        transition: color 0.3s ease;
      }

      /* Dark Mode */
      [data-theme="dark"] .blog-title {
        color: #fff;
      }

      .theme-toggle:hover {
        transform: scale(1.1);
      }

      .theme-toggle i {
        font-size: 1.5rem;
        color: var(--text-primary);
      }

      .blog-container,
      .alert,
      .comment-container,
      .follow-container {
        background-color: var(--card-bg);
        color: var(--text-color);
        border: 1px solid var(--border-color);
        transition: background 0.3s ease, color 0.3s ease, border 0.3s ease;
      }

      .bookmark-btn,
      .like-button,
      .follow-button {
        background: transparent;
        color: var(--text-color);
        border: none;
      }

      .bookmark-btn i,
      .like-button i {
        color: var(--text-color);
      }

      .share-buttons i {
        transition: color 0.3s;
      }

      .form-control {
        background-color: var(--card-bg);
        color: var(--text-color);
        border: 1px solid var(--border-color);
      }

      .form-control::placeholder {
        color: var(--text-color);
        opacity: 0.6;
      }

      .theme-text {
        color: var(--text-color);
        transition: color 0.3s ease;
      }

      .bookmark-btn i {
        color: var(--text-color);
        transition: color 0.3s ease;
      }

      .theme-bg {
        background-color: var(--bg-color);
        transition: background-color 0.3s ease;
      }

      .follow-button {
        transition: background-color 0.3s ease, color 0.3s ease;
      }

      /* Blog Body Content Styling */
      .blog-body {
        white-space: pre-wrap;
        word-wrap: break-word;
        font-family: inherit;
        line-height: 1.8;
        color: var(--text-color);
        background-color: var(--card-bg);
        padding: 2rem;
        border-radius: 8px;
        margin: 20px 0;
        letter-spacing: 0.3px;
        font-weight: 500;
      }

      /* Paragraph spacing within blog body */
      .blog-body p {
        margin-bottom: 1.5rem;
        font-weight: 500;
      }

      /* Line break handling */
      .blog-body br {
        display: block;
        content: "";
        margin-top: 1rem;     /* Space after line breaks */
      }

      /* List styling within blog body */
      .blog-body ul,
      .blog-body ol {
        margin: 1.5rem 0;
        padding-left: 2rem;
        font-weight: 500;
      }

      .blog-body li {
        margin-bottom: 0.5rem;
        font-weight: 500;
      }

      /* Blockquote styling */
      .blog-body blockquote {
        border-left: 4px solid var(--accent-color);
        margin: 1.5rem 0;
        padding: 1rem 2rem;
        background-color: var(--card-bg);
        font-style: italic;
        font-weight: 600;
      }

      /* Code block styling */
      .blog-body pre,
      .blog-body code {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 0.2rem 0.4rem;
        font-family: monospace;
      }

      .blog-body pre {
        padding: 1rem;
        margin: 1.5rem 0;
        overflow-x: auto;
      }

      [data-theme="dark"] .blog-body {
        background-color: var(--card-bg);
        color: var(--text-primary);
      }
    </style>
  </head>

  <body class="p-2">
    <%- include('./partials/nav', { searchQuery: searchQuery }) %> <% var
    blogUrl="https://yourwebsite.com/blog/" + blog._id; %>

    <div id="progress-container">
      <div id="progress-bar"></div>
    </div>

    <!-- flash message -->
    <div class="container mt-3">
      <% if (success_msg.length> 0) { %>
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        <%= success_msg %>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
          aria-label="Close"
        ></button>
      </div>
      <% } %> <% if (error_msg.length> 0) { %>
      <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <%= error_msg %>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
          aria-label="Close"
        ></button>
      </div>
      <% } %>
    </div>

    <!-- blog -->
    <div class="container mt-4">
      <article class="p-4 shadow rounded blog-container">
        <h1 class="fw-bold blog-title"><%= blog.title %></h1>

        <div class="d-flex justify-content-between align-items-center">
          <h6 class="theme-text">
            <i class="far fa-calendar-alt"></i>
            <%= formattedDate %>
          </h6>
          <h6 class="theme-text">
            <i class="far fa-eye"></i>
            <%= blog.views %> views
          </h6>
        </div>

        <!-- Bookmark -->
        <div class="d-flex justify-content-end">
          <button id="bookmark-btn" class="bookmark-btn">
            <i
              id="bookmark-icon"
              class="<%= isBookmarked ? 'fa-solid' : 'fa-regular' %> fa-bookmark"
            ></i>
          </button>
        </div>

        <!-- Blog Cover Image -->
        <div class="text-center mt-3">
          <img
            class="rounded shadow-lg img-fluid blog-image"
            src="<%= blog.coverImageURL && blog.coverImageURL !== '' ? blog.coverImageURL : 'default-cover.png' %>"
            alt="Blog Cover"
          />
        </div>

        <!-- Blog Content -->
        <div class="mt-4 lead blog-body">
          <%- blog.body %>
        </div>

        <div class="d-flex gap-3 align-items-center mt-3">
          <div class="d-flex gap-3 mr-auto">
            <button
              class="like-button"
              id="likeButton"
              data-blog-id="<%= blog._id %>"
            >
              <i
                id="likeIcon"
                class="<%= user && blog.likedBy.includes(user._id.toString()) ? 'fas text-primary' : 'far' %> fa-thumbs-up fs-4"
              ></i>
              <% if (user &&
              blog.createdBy._id.toString()===user._id.toString()) { %>
              <span id="likeCount" class="ms-2 likeCount theme-text fs-5">
                <%= blog.likes || 0 %>
              </span>
              <% } %>
            </button>

            <!-- Share Buttons -->
            <div class="share-buttons">
              <a
                href="https://www.facebook.com/sharer/sharer.php?u=<%= blogUrl %>"
                target="_blank"
              >
                <i class="fab fa-facebook-square fa-2x text-primary"></i>
              </a>
              <a
                href="https://twitter.com/intent/tweet?url=<%= blogUrl %>"
                target="_blank"
              >
                <i class="fab fa-twitter-square fa-2x text-info"></i>
              </a>
              <a
                href="https://www.linkedin.com/shareArticle?mini=true&url=<%= blogUrl %>"
                target="_blank"
              >
                <i class="fab fa-linkedin fa-2x text-primary"></i>
              </a>
              <a href="https://wa.me/?text=<%= blogUrl %>" target="_blank">
                <i class="fab fa-whatsapp fa-2x text-success"></i>
              </a>
            </div>
          </div>

          <!-- View Profile -->
          <% if (!user || String(user._id) !==String(blog.createdBy._id)) { %>
          <a
            href="/user/profile/<%= blog.createdBy._id %>"
            class="btn btn-primary"
            >View Profile</a
          >
          <% } %>
        </div>
      </article>

      <!-- Author & Follow Section -->
      <div
        class="mt-4 p-3 container d-flex p-1 bd-highlight user-select-none justify-content-between align-items-center"
      >
        <% if (user && String(user._id) !==String(blog.createdBy._id)) { %>
        <form method="POST" action="/user/follow/<%= blog.createdBy._id %>">
          <button
            type="submit"
            class="btn follow-button <%= (user.following && user.following.includes(blog.createdBy._id)) ? 'btn-success' : 'btn-primary' %>"
          >
            <%= (user.following && user.following.includes(blog.createdBy._id))
            ? 'Followed' : 'Follow' %>
          </button>
        </form>
        <% } %>
        <h5 class="ms-3 theme-text">@ <%= blog.createdBy.fullName %></h5>
      </div>
    </div>

    <!-- comments section -->
    <div class="mt-4 p-3 container">
      <label class="form-label fw-bold fs-3"
        >Comments (<%= comments.length %>)</label
      >

      <% if (user) { %>
      <form method="post" action="/blog/comment/<%= blog._id %>">
        <div class="d-flex gap-3">
          <input
            type="text"
            class="form-control"
            id="commentInput"
            autocomplete="off"
            placeholder="Leave a comment..."
            name="content"
            required
          />
          <button type="submit" class="btn btn-primary">Submit</button>
        </div>
      </form>
      <% } else { %>
      <p class="mt-2">Please <a href="/user/signin">login</a> to comment.</p>
      <% } %>
    </div>

    <!-- Display Comments -->
    <div class="container mt-4">
      <% comments.forEach(comment=> { %>
      <div
        class="d-flex justify-content-start theme-bg align-items-baseline p-2 mb-2 rounded"
      >
        <div
          class="d-flex justify-content-start align-items-baseline gap-2 p-2 rounded"
        >
          <h6 class="fst-italic theme-text">
            <%= comment.createdBy.fullName %>:
          </h6>
          <p class="fw-bold fst-italic theme-text"><%= comment.content %></p>
        </div>
        <p class="fw-lighter fst-italic theme-text ms-auto">
          <%= moment(comment.createdAt).fromNow() %>
        </p>
      </div>
      <% }) %>
    </div>

    <%- include('./partials/footer') %>

    <!-- Theme Toggle Button -->
   

    <script> // THEME TOGGLE SCRIPT
      (function () {
        const root = document.documentElement;
        const icon = document.getElementById('themeIcon');
        const currentTheme = localStorage.getItem('theme');

        function applyTheme(theme) {
          root.setAttribute('data-theme', theme);
          localStorage.setItem('theme', theme);
          if (icon) {
            icon.classList.remove('fa-moon', 'fa-sun');
            icon.classList.add(theme === 'dark' ? 'fa-sun' : 'fa-moon');
          }
        }

        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (currentTheme === 'dark' || (!currentTheme && prefersDark)) {
          applyTheme('dark');
        } else {
          applyTheme('light');
        }

        if (icon) {
          icon.parentElement.addEventListener('click', () => {
            const current = root.getAttribute('data-theme');
            const newTheme = current === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
          });
        }
      })();
    </script>
  </body>
</html>
